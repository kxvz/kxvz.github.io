{"name":"ca","slug":"ca","count":1,"postlist":[{"title":"在CentOS上制作CA证书并绑定到Nginx上","slug":"在CentOS上制作CA证书并绑定到Nginx上","date":"2018-12-12T02:02:06.000Z","updated":"2018-12-12T02:02:06.603Z","comments":true,"path":"api/articles/在CentOS上制作CA证书并绑定到Nginx上.json","excerpt":"","keywords":null,"cover":null,"content":"<div class=\"highlight-wrap\"autocomplete=\"off\" autocorrect=\"off\" autocapitalize=\"off\" spellcheck=\"false\" contenteditable=\"true\"data-rel=\"CMD\"><figure class=\"iseeu highlight cmd\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">//创建根证书密钥文件</span><br><span class=\"line\">openssl genrsa -des3 -out test.key</span><br><span class=\"line\">//创建根证书的申请文件</span><br><span class=\"line\">openssl req -new -key test.key -out test.csr</span><br><span class=\"line\">//创建一个自当前日期起为期十年的根证书</span><br><span class=\"line\">openssl x509 -req -days <span class=\"number\">3650</span> -sha1 -extensions v3_ca -signkey test.key -<span class=\"keyword\">in</span> test.csr -out test.crt</span><br><span class=\"line\"></span><br><span class=\"line\">//创建服务器证书密钥</span><br><span class=\"line\">openssl genrsa -des3 -out server.key <span class=\"number\">2048</span></span><br><span class=\"line\">//创建服务器证书的申请文件</span><br><span class=\"line\">openssl req -new -key server.key -out server.csr</span><br><span class=\"line\">//创建自当前日期起有效期为期两年的服务器证书</span><br><span class=\"line\">openssl x509 -req -days <span class=\"number\">730</span> -sha1 -extensions v3_req -CA test.crt -CAkey test.key -CAserial test.srl -CAcreateserial -<span class=\"keyword\">in</span> server.csr -out server.crt</span><br><span class=\"line\"></span><br><span class=\"line\">//创建客户端证书密钥文件</span><br><span class=\"line\">openssl genrsa -des3 -out client.key <span class=\"number\">2048</span></span><br><span class=\"line\">//创建客户端证书的申请文件</span><br><span class=\"line\">openssl req -new -key client.key -out client.csr</span><br><span class=\"line\">//创建一个自当前日期起有效期为两年的客户端证书</span><br><span class=\"line\">openssl x509 -req -days <span class=\"number\">730</span> -sha1 -extensions v3_req -CA test.crt -CAkey test.key -CAserial test.srl -CAcreateserial -<span class=\"keyword\">in</span> client.csr -out client.crt</span><br><span class=\"line\"></span><br><span class=\"line\">//将客户端证书文件client.crt和客户端证书密钥文件client.key合并成客户端证书安装包client.pfx</span><br><span class=\"line\">openssl pkcs12 -export -<span class=\"keyword\">in</span> client.crt -inkey client.key -out client.pfx</span><br><span class=\"line\"></span><br><span class=\"line\">//保存生成的文件备用，其中server.crt和server.key是配置单向SSL时需要使用的证书文件，client.crt是配置双向SSL时需要使用的证书文件，client.pfx是配置双向SSL时需要客户端安装的证书文件</span><br><span class=\"line\"></span><br><span class=\"line\">//证书合并</span><br><span class=\"line\">cat server.key server.crt &gt; server.pem</span><br><span class=\"line\">cat client.key client.crt &gt; client.pem</span><br><span class=\"line\"></span><br><span class=\"line\">//配置到Nginx中:</span><br><span class=\"line\"></span><br><span class=\"line\">server &#123;</span><br><span class=\"line\">    #添加<span class=\"number\">443</span>监听</span><br><span class=\"line\">    listen       <span class=\"number\">443</span>;</span><br><span class=\"line\">    #开启SSL</span><br><span class=\"line\">    ssl  on;</span><br><span class=\"line\">    #指定PEM格式的证书文件   </span><br><span class=\"line\">    ssl_certificate      /etc/nginx/conf.d/keys/server.pem;</span><br><span class=\"line\">    ssl_client_certificate     /etc/nginx/conf.d/keys/client.pem;</span><br><span class=\"line\">    ssl_certificate_key  /etc/nginx/conf.d/keys/server.key;</span><br><span class=\"line\"></span><br><span class=\"line\">    ssl_session_cache shared:SSL:<span class=\"number\">1</span>m;</span><br><span class=\"line\">    ssl_session_timeout  <span class=\"number\">5</span>m;</span><br><span class=\"line\"></span><br><span class=\"line\">    ssl_protocols SSLv2 SSLv3 TLSv1;</span><br><span class=\"line\">    ssl_ciphers  ALL:<span class=\"variable\">!ADH:!</span>EXPORT56:RC4+RSA:+HIGH:+MEDIUM:+LOW:+SSLv2:+EXP;</span><br><span class=\"line\">    ssl_prefer_server_ciphers   on;</span><br><span class=\"line\"></span><br><span class=\"line\">    #将所有的http请求通过rewrite重写到https上即可</span><br><span class=\"line\">    # rewrite ^(.*)$  https://$host$<span class=\"number\">1</span> permanent;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">// 所有的操作完成后需要重启 Nginx 并输入证书密码</span><br><span class=\"line\"> service nginx restart</span><br></pre></td></tr></table></figure></div>\n<p>附 nginx.conf:<br><div class=\"highlight-wrap\"autocomplete=\"off\" autocorrect=\"off\" autocapitalize=\"off\" spellcheck=\"false\" contenteditable=\"true\"data-rel=\"PLAIN\"><figure class=\"iseeu highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">user nginx;</span><br><span class=\"line\">worker_processes auto;</span><br><span class=\"line\">error_log /var/log/nginx/error.log;</span><br><span class=\"line\">pid /run/nginx.pid;</span><br><span class=\"line\"></span><br><span class=\"line\">events &#123;</span><br><span class=\"line\">    worker_connections 1024;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">http &#123;</span><br><span class=\"line\">    sendfile            on;</span><br><span class=\"line\">    tcp_nopush          on;</span><br><span class=\"line\">    tcp_nodelay         on;</span><br><span class=\"line\">    keepalive_timeout   65;</span><br><span class=\"line\">    types_hash_max_size 2048;</span><br><span class=\"line\"></span><br><span class=\"line\">    include             /etc/nginx/mime.types;</span><br><span class=\"line\">    default_type        application/octet-stream;</span><br><span class=\"line\">\t</span><br><span class=\"line\">\tupstream backend &#123;</span><br><span class=\"line\">\t\tserver 127.0.0.1:8080;</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    server &#123;</span><br><span class=\"line\">        listen 443;</span><br><span class=\"line\">        server_name loyom.com; #填写绑定证书的域名</span><br><span class=\"line\">        ssl on;</span><br><span class=\"line\">        ssl_certificate /opt/ca/1_loyom.com_bundle.crt;</span><br><span class=\"line\">        ssl_certificate_key /opt/ca/2_loyom.com.key;</span><br><span class=\"line\">        ssl_session_timeout 5m;</span><br><span class=\"line\">        ssl_protocols TLSv1.2;</span><br><span class=\"line\">        ssl_ciphers ECDHE-RSA-AES128-GCM-SHA256:HIGH:!aNULL:!MD5:!RC4:!DHE;</span><br><span class=\"line\">        ssl_prefer_server_ciphers on;</span><br><span class=\"line\">\t\t</span><br><span class=\"line\">\t\tlocation / &#123;</span><br><span class=\"line\">\t\t\tproxy_set_header Host $host;</span><br><span class=\"line\">\t\t\tproxy_set_header X-Real-IP $remote_addr;</span><br><span class=\"line\">\t\t\tproxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;</span><br><span class=\"line\">\t\t   </span><br><span class=\"line\">\t\t\tproxy_buffering off;</span><br><span class=\"line\">\t\t\tproxy_pass http://backend;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">\t</span><br><span class=\"line\">\tserver &#123;</span><br><span class=\"line\">        listen 80;</span><br><span class=\"line\">\t\t</span><br><span class=\"line\">        location / &#123;</span><br><span class=\"line\">\t\t\tproxy_set_header Host $host;</span><br><span class=\"line\">\t\t\tproxy_set_header X-Real-IP $remote_addr;</span><br><span class=\"line\">\t\t\tproxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;</span><br><span class=\"line\">\t\t   </span><br><span class=\"line\">\t\t\tproxy_buffering off;</span><br><span class=\"line\">\t\t\tproxy_pass http://backend;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure></div></p>\n","text":"1<br>2<br>3<br>4<br>5<br>6<br>7<br>8<br>9<br>10<br>11<br>12<br>13<br>14<br>15<br>16<br>17<br>18<br>19<br>20<br>21<br>22<br>23<br>24<br>25<br","link":"","raw":null,"photos":[],"categories":[{"name":"Centos","slug":"Centos","count":30,"path":"api/categories/Centos.json"},{"name":"nginx","slug":"Centos/nginx","count":2,"path":"api/categories/Centos/nginx.json"},{"name":"ca","slug":"Centos/nginx/ca","count":1,"path":"api/categories/Centos/nginx/ca.json"}],"tags":[{"name":"Centos","slug":"Centos","count":29,"path":"api/tags/Centos.json"},{"name":"nginx","slug":"nginx","count":3,"path":"api/tags/nginx.json"},{"name":"ca","slug":"ca","count":1,"path":"api/tags/ca.json"},{"name":"openssl","slug":"openssl","count":1,"path":"api/tags/openssl.json"}]}]}