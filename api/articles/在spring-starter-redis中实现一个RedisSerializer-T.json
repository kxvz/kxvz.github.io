{"title":"在spring-starter-redis中实现一个RedisSerializer<T>","slug":"在spring-starter-redis中实现一个RedisSerializer-T","date":"2018-12-11T09:12:53.000Z","updated":"2018-12-11T09:12:53.090Z","comments":true,"path":"api/articles/在spring-starter-redis中实现一个RedisSerializer-T.json","photos":[],"link":"","excerpt":"","covers":null,"content":"<h1 id=\"实现一个RedisSerializer用在spring-boot-starter-data-redis中\"><a href=\"#实现一个RedisSerializer用在spring-boot-starter-data-redis中\" class=\"headerlink\" title=\"实现一个RedisSerializer用在spring-boot-starter-data-redis中\"></a>实现一个RedisSerializer<t>用在spring-boot-starter-data-redis中</t></h1><h3 id=\"需求\"><a href=\"#需求\" class=\"headerlink\" title=\"需求:\"></a>需求:</h3><p>因为会使用到Spring-redis作为缓存框架缓存数据,不让程序每次查询都进到数据库中,因此正对不同的数据格式需要进行序列化和反序列化,于是就自己实现了一个简单的序列化类</p>\n<h3 id=\"首先-配置-Springboot-的-redis-配置\"><a href=\"#首先-配置-Springboot-的-redis-配置\" class=\"headerlink\" title=\"首先 配置 Springboot 的 redis 配置\"></a>首先 配置 Springboot 的 redis 配置</h3><figure class=\"highlight\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># REDIS (RedisProperties)</span></span><br><span class=\"line\"><span class=\"comment\"># Redis数据库索引（默认为0）</span></span><br><span class=\"line\">spring.redis.database=0  </span><br><span class=\"line\"><span class=\"comment\"># Redis服务器地址</span></span><br><span class=\"line\">spring.redis.host=192.168.0.11</span><br><span class=\"line\"><span class=\"comment\"># Redis服务器连接端口</span></span><br><span class=\"line\">spring.redis.port=6379  </span><br><span class=\"line\"><span class=\"comment\"># Redis服务器连接密码（默认为空）</span></span><br><span class=\"line\">spring.redis.password=ThisIsPass</span><br><span class=\"line\"><span class=\"comment\"># 连接池最大连接数（使用负值表示没有限制）</span></span><br><span class=\"line\">spring.redis.pool.max-active=-1  </span><br><span class=\"line\"><span class=\"comment\"># 连接池最大阻塞等待时间（使用负值表示没有限制）</span></span><br><span class=\"line\">spring.redis.pool.max-wait=-1  </span><br><span class=\"line\"><span class=\"comment\"># 连接池中的最大空闲连接</span></span><br><span class=\"line\">spring.redis.pool.max-idle=8  </span><br><span class=\"line\"><span class=\"comment\"># 连接池中的最小空闲连接</span></span><br><span class=\"line\">spring.redis.pool.min-idle=2  </span><br><span class=\"line\"><span class=\"comment\"># 连接超时时间（毫秒）</span></span><br><span class=\"line\">spring.redis.timeout=50</span><br></pre></td></tr></table></figure>\n<h3 id=\"接下来实现-序列化类-这里使用到了GSON\"><a href=\"#接下来实现-序列化类-这里使用到了GSON\" class=\"headerlink\" title=\"接下来实现 序列化类 (这里使用到了GSON):\"></a>接下来实现 序列化类 (这里使用到了GSON):</h3><div class=\"highlight-wrap\"autocomplete=\"off\" autocorrect=\"off\" autocapitalize=\"off\" spellcheck=\"false\" contenteditable=\"true\"data-rel=\"JAVA\"><figure class=\"iseeu highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">import</span> org.springframework.data.redis.serializer.RedisSerializer;</span><br><span class=\"line\"><span class=\"keyword\">import</span> org.springframework.data.redis.serializer.SerializationException;</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">public</span> <span class=\"class\"><span class=\"keyword\">class</span> <span class=\"title\">RedisValueSerializer</span>&lt;<span class=\"title\">T</span>&gt; <span class=\"keyword\">implements</span> <span class=\"title\">RedisSerializer</span>&lt;<span class=\"title\">T</span>&gt; </span>&#123;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">private</span> <span class=\"keyword\">static</span> <span class=\"keyword\">final</span> <span class=\"keyword\">byte</span>[] EMPTY_ARRAY = <span class=\"keyword\">new</span> <span class=\"keyword\">byte</span>[<span class=\"number\">0</span>];</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"meta\">@Override</span></span><br><span class=\"line\">    <span class=\"keyword\">public</span> <span class=\"keyword\">byte</span>[] serialize(T t) <span class=\"keyword\">throws</span> SerializationException &#123;</span><br><span class=\"line\">        <span class=\"keyword\">if</span> (t == <span class=\"keyword\">null</span>) &#123;</span><br><span class=\"line\">            <span class=\"keyword\">return</span> EMPTY_ARRAY;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">        String tmp = String.format(<span class=\"string\">\"%s_%s\"</span>, t.getClass().getName(), JsonUtils.obj2Json(t));</span><br><span class=\"line\">        <span class=\"keyword\">return</span> tmp.getBytes(Encode.UTF8);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"meta\">@Override</span></span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> T <span class=\"title\">deserialize</span><span class=\"params\">(<span class=\"keyword\">byte</span>[] bytes)</span> <span class=\"keyword\">throws</span> SerializationException </span>&#123;</span><br><span class=\"line\">        <span class=\"keyword\">try</span> &#123;</span><br><span class=\"line\">            <span class=\"keyword\">if</span> (bytes == <span class=\"keyword\">null</span> || bytes.length &lt;= <span class=\"number\">0</span>) &#123;</span><br><span class=\"line\">                <span class=\"keyword\">return</span> <span class=\"keyword\">null</span>;</span><br><span class=\"line\">            &#125;</span><br><span class=\"line\">            String tmp = <span class=\"keyword\">new</span> String(bytes, Encode.UTF8);</span><br><span class=\"line\">            String className = tmp.substring(<span class=\"number\">0</span>, tmp.indexOf(<span class=\"string\">\"_&#123;\"</span>));</span><br><span class=\"line\">            String json = tmp.substring(tmp.indexOf(<span class=\"string\">\"_&#123;\"</span>) + <span class=\"number\">1</span>);</span><br><span class=\"line\">            <span class=\"keyword\">return</span> (T) JsonUtils.json2Obj(json, Class.forName(className));</span><br><span class=\"line\">        &#125; <span class=\"keyword\">catch</span> (ClassNotFoundException ex) &#123;</span><br><span class=\"line\">            LogUtils.error(TAG.DEF, <span class=\"keyword\">this</span>.getClass(), <span class=\"string\">\"deserialize\"</span>, ex);</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">        <span class=\"keyword\">return</span> <span class=\"keyword\">null</span>;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure></div>\n<h3 id=\"然后RedisConfig\"><a href=\"#然后RedisConfig\" class=\"headerlink\" title=\"然后RedisConfig:\"></a>然后RedisConfig:</h3><div class=\"highlight-wrap\"autocomplete=\"off\" autocorrect=\"off\" autocapitalize=\"off\" spellcheck=\"false\" contenteditable=\"true\"data-rel=\"JAVA\"><figure class=\"iseeu highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">import</span> org.springframework.cache.CacheManager;</span><br><span class=\"line\"><span class=\"keyword\">import</span> org.springframework.cache.annotation.CachingConfigurerSupport;</span><br><span class=\"line\"><span class=\"keyword\">import</span> org.springframework.context.annotation.Bean;</span><br><span class=\"line\"><span class=\"keyword\">import</span> org.springframework.context.annotation.Configuration;</span><br><span class=\"line\"><span class=\"keyword\">import</span> org.springframework.context.annotation.Primary;</span><br><span class=\"line\"><span class=\"keyword\">import</span> org.springframework.data.redis.cache.RedisCacheManager;</span><br><span class=\"line\"><span class=\"keyword\">import</span> org.springframework.data.redis.connection.RedisConnectionFactory;</span><br><span class=\"line\"><span class=\"keyword\">import</span> org.springframework.data.redis.core.RedisTemplate;</span><br><span class=\"line\"><span class=\"keyword\">import</span> org.springframework.data.redis.core.StringRedisTemplate;</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"meta\">@Primary</span></span><br><span class=\"line\"><span class=\"meta\">@Configuration</span></span><br><span class=\"line\"><span class=\"keyword\">public</span> <span class=\"class\"><span class=\"keyword\">class</span> <span class=\"title\">RedisConfig</span> <span class=\"keyword\">extends</span> <span class=\"title\">CachingConfigurerSupport</span> </span>&#123;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"meta\">@Primary</span></span><br><span class=\"line\">    <span class=\"meta\">@Bean</span></span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> CacheManager <span class=\"title\">cacheManager</span><span class=\"params\">(RedisTemplate redisTemplate)</span> </span>&#123;</span><br><span class=\"line\">        RedisCacheManager rcm = <span class=\"keyword\">new</span> RedisCacheManager(redisTemplate);</span><br><span class=\"line\">        <span class=\"keyword\">return</span> rcm;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"meta\">@Primary</span></span><br><span class=\"line\">    <span class=\"meta\">@Bean</span></span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> StringRedisTemplate <span class=\"title\">redisTemplate</span><span class=\"params\">(RedisConnectionFactory factory)</span> </span>&#123;</span><br><span class=\"line\">        StringRedisTemplate template = <span class=\"keyword\">new</span> StringRedisTemplate(factory);</span><br><span class=\"line\">        template.setValueSerializer(<span class=\"keyword\">new</span> RedisValueSerializer&lt;Object&gt;());</span><br><span class=\"line\">        template.afterPropertiesSet();</span><br><span class=\"line\">        <span class=\"keyword\">return</span> template;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure></div>\n<h3 id=\"然后就可以使用缓存注解了\"><a href=\"#然后就可以使用缓存注解了\" class=\"headerlink\" title=\"然后就可以使用缓存注解了:\"></a>然后就可以使用缓存注解了:</h3><div class=\"highlight-wrap\"autocomplete=\"off\" autocorrect=\"off\" autocapitalize=\"off\" spellcheck=\"false\" contenteditable=\"true\"data-rel=\"JAVA\"><figure class=\"iseeu highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\">@Cacheable</span>(key =<span class=\"string\">\"#p0\"</span>) </span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"meta\">@CachePut</span>(key = <span class=\"string\">\"#p0\"</span>)</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"meta\">@CacheEvict</span>(key =<span class=\"string\">\"#p0\"</span>,allEntries=<span class=\"keyword\">true</span>)</span><br><span class=\"line\"></span><br><span class=\"line\">...</span><br></pre></td></tr></table></figure></div>\n<h3 id=\"注解使用参考\"><a href=\"#注解使用参考\" class=\"headerlink\" title=\"注解使用参考:\"></a>注解使用参考:</h3><p><a href=\"http://blog.csdn.net/sanjay_f/article/details/47372967\" target=\"_blank\" rel=\"noopener\">http://blog.csdn.net/sanjay_f/article/details/47372967</a></p>\n","categories":[{"name":"java","slug":"java","count":21,"path":"api/categories/java.json"},{"name":"redis","slug":"java/redis","count":1,"path":"api/categories/java/redis.json"},{"name":"RedisSerializer","slug":"java/redis/RedisSerializer","count":1,"path":"api/categories/java/redis/RedisSerializer.json"}],"tags":[{"name":"java","slug":"java","count":25,"path":"api/tags/java.json"},{"name":"redis","slug":"redis","count":3,"path":"api/tags/redis.json"},{"name":"spring-boot","slug":"spring-boot","count":3,"path":"api/tags/spring-boot.json"},{"name":"RedisSerializer","slug":"RedisSerializer","count":1,"path":"api/tags/RedisSerializer.json"}]}