{"title":"在Centos7上搭建Ngrok服务","slug":"在Centos7上搭建Ngrok服务","date":"2018-12-11T09:42:59.000Z","updated":"2018-12-11T09:42:59.246Z","comments":true,"path":"api/articles/在Centos7上搭建Ngrok服务.json","photos":[],"link":"","excerpt":"","covers":null,"content":"<div class=\"highlight-wrap\"autocomplete=\"off\" autocorrect=\"off\" autocapitalize=\"off\" spellcheck=\"false\" contenteditable=\"true\"data-rel=\"BASH\"><figure class=\"iseeu highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br><span class=\"line\">75</span><br><span class=\"line\">76</span><br><span class=\"line\">77</span><br><span class=\"line\">78</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">### 首先先装好一些编译需要使用的工具</span></span><br><span class=\"line\">yum -y install zlib-devel openssl-devel perl hg cpio expat-devel gettext-devel curl curl-devel </span><br><span class=\"line\">perl-ExtUtils-MakeMaker hg wget gcc gcc-c++</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">### 安装好Git 最好是1.8+</span></span><br><span class=\"line\">yum install -y git</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">### 安装 Go 一定注意要找 1.4.3版本的 下载地址:https://golang.org/dl/   </span></span><br><span class=\"line\">wget https://storage.googleapis.com/golang/go1.4.3.linux-amd64.tar.gz</span><br><span class=\"line\"></span><br><span class=\"line\">tar -C /usr/<span class=\"built_in\">local</span> -xzf go1.4.3.linux-amd64.tar.gz</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">### 添加Go的环境变量 首先打开 profile 在最后加上 export PATH=$PATH:/usr/local/go/bin</span></span><br><span class=\"line\"></span><br><span class=\"line\">vi /etc/profile</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"built_in\">export</span> PATH=<span class=\"variable\">$PATH</span>:/usr/<span class=\"built_in\">local</span>/go/bin</span><br><span class=\"line\"></span><br><span class=\"line\">go version</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">### 下载 ngrok 源码</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"built_in\">cd</span> /usr/<span class=\"built_in\">local</span>/</span><br><span class=\"line\">git <span class=\"built_in\">clone</span> https://github.com/inconshreveable/ngrok.git</span><br><span class=\"line\"><span class=\"built_in\">export</span> GOPATH=/usr/<span class=\"built_in\">local</span>/ngrok/</span><br><span class=\"line\"><span class=\"built_in\">export</span> NGROK_DOMAIN=<span class=\"string\">\"[此处填写你的域名:如: baidu.com]\"</span></span><br><span class=\"line\"><span class=\"built_in\">cd</span> ngrok</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">### 生成SSL证书 用于 Ngrok 服务端和客户端通信认证使用</span></span><br><span class=\"line\"></span><br><span class=\"line\">openssl genrsa -out rootCA.key 2048</span><br><span class=\"line\">openssl req -x509 -new -nodes -key rootCA.key -subj <span class=\"string\">\"/CN=<span class=\"variable\">$NGROK_DOMAIN</span>\"</span> -days 5000 -out rootCA.pem</span><br><span class=\"line\">openssl genrsa -out server.key 2048</span><br><span class=\"line\">openssl req -new -key server.key -subj <span class=\"string\">\"/CN=<span class=\"variable\">$NGROK_DOMAIN</span>\"</span> -out server.csr</span><br><span class=\"line\">openssl x509 -req -<span class=\"keyword\">in</span> server.csr -CA rootCA.pem -CAkey rootCA.key -CAcreateserial -out server.crt -days 5000</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">### 复制证书到 tls下</span></span><br><span class=\"line\"></span><br><span class=\"line\">\\cp -r rootCA.pem assets/client/tls/ngrokroot.crt</span><br><span class=\"line\">\\cp -r server.crt assets/server/tls/snakeoil.crt</span><br><span class=\"line\">\\cp -r server.key assets/server/tls/snakeoil.key</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">### 国内的网络环境需要改一点代码</span></span><br><span class=\"line\"></span><br><span class=\"line\">vi /usr/<span class=\"built_in\">local</span>/ngrok/src/ngrok/<span class=\"built_in\">log</span>/logger.go</span><br><span class=\"line\"><span class=\"built_in\">log</span> <span class=\"string\">\"github.com/keepeye/log4go\"</span></span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">### 编译Server端 注意替换 GOOS 和 GOARCH , 具体的值可以通过命令 go env 查看</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"built_in\">cd</span> /usr/<span class=\"built_in\">local</span>/go/src</span><br><span class=\"line\">GOOS=linux GOARCH=amd64 ./make.bash</span><br><span class=\"line\"><span class=\"built_in\">cd</span> /usr/<span class=\"built_in\">local</span>/ngrok/</span><br><span class=\"line\">GOOS=linux GOARCH=amd64 make release-server</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">### 编译客户端</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"built_in\">cd</span> /usr/<span class=\"built_in\">local</span>/go/src</span><br><span class=\"line\">GOOS=linux GOARCH=amd64 ./make.bash</span><br><span class=\"line\"><span class=\"built_in\">cd</span> /usr/<span class=\"built_in\">local</span>/ngrok/</span><br><span class=\"line\">GOOS=linux GOARCH=amd64 make release-client</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">### 服务端启动</span></span><br><span class=\"line\"></span><br><span class=\"line\">/usr/<span class=\"built_in\">local</span>/ngrok/bin/ngrokd -domain=<span class=\"string\">\"<span class=\"variable\">$NGROK_DOMAIN</span>\"</span> -httpAddr=<span class=\"string\">\":80\"</span></span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">### 客户端配置文件</span></span><br><span class=\"line\">server_addr: <span class=\"string\">\"ngrok.sunnyos.com:4443\"</span></span><br><span class=\"line\">trust_host_root_certs: <span class=\"literal\">false</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">### 启动客户端</span></span><br><span class=\"line\">./ngrok -config=./ngrok.cfg -subdomain=blog 80</span><br><span class=\"line\"></span><br><span class=\"line\">setsid ./ngrok -config=./ngrok.cfg -subdomain=<span class=\"built_in\">test</span> 80 <span class=\"comment\">#在linux下如果想后台运行</span></span><br></pre></td></tr></table></figure></div>\n","categories":[{"name":"Centos","slug":"Centos","count":30,"path":"api/categories/Centos.json"},{"name":"ngrok","slug":"Centos/ngrok","count":1,"path":"api/categories/Centos/ngrok.json"},{"name":"nat","slug":"Centos/ngrok/nat","count":1,"path":"api/categories/Centos/ngrok/nat.json"}],"tags":[{"name":"Centos","slug":"Centos","count":29,"path":"api/tags/Centos.json"},{"name":"nat","slug":"nat","count":2,"path":"api/tags/nat.json"},{"name":"ngrok","slug":"ngrok","count":1,"path":"api/tags/ngrok.json"}]}