{"title":"关于Mysql使用存储过程，并且使用游标的Demo","slug":"关于Mysql使用存储过程，并且使用游标的Demo","date":"2018-12-11T10:06:50.000Z","updated":"2018-12-11T10:06:50.484Z","comments":true,"path":"api/articles/关于Mysql使用存储过程，并且使用游标的Demo.json","photos":[],"link":"","excerpt":"","covers":null,"content":"<div class=\"highlight-wrap\"autocomplete=\"off\" autocorrect=\"off\" autocapitalize=\"off\" spellcheck=\"false\" contenteditable=\"true\"data-rel=\"SQL\"><figure class=\"iseeu highlight sql\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">DELIMITER $$</span><br><span class=\"line\"><span class=\"comment\">/* Mysql 创建存储过程 名为：new_pro */</span></span><br><span class=\"line\"><span class=\"keyword\">CREATE</span> DEFINER=<span class=\"string\">`root`</span>@<span class=\"string\">`localhost`</span> <span class=\"keyword\">PROCEDURE</span> <span class=\"string\">`new_pro`</span>()</span><br><span class=\"line\"><span class=\"keyword\">BEGIN</span></span><br><span class=\"line\">    <span class=\"comment\">/* 声明变量 并设定默认值 */</span></span><br><span class=\"line\">    <span class=\"keyword\">Declare</span> not_found <span class=\"built_in\">int</span>  <span class=\"keyword\">default</span> <span class=\"number\">0</span>;</span><br><span class=\"line\">    <span class=\"keyword\">Declare</span> collectionId <span class=\"built_in\">bigint</span>;</span><br><span class=\"line\">    <span class=\"keyword\">Declare</span> children_collectionId <span class=\"built_in\">bigint</span>;</span><br><span class=\"line\">    <span class=\"comment\">/* 创建游标 通过查询表 channelcollection创建出游标 */</span></span><br><span class=\"line\">    <span class=\"keyword\">Declare</span> idCursor <span class=\"keyword\">cursor</span> <span class=\"keyword\">for</span> <span class=\"keyword\">select</span> <span class=\"keyword\">id</span> <span class=\"keyword\">from</span> channelcollection <span class=\"keyword\">where</span> <span class=\"keyword\">name</span>=<span class=\"string\">'a'</span> <span class=\"keyword\">or</span> <span class=\"keyword\">name</span>=<span class=\"string\">'c'</span>;</span><br><span class=\"line\">    <span class=\"comment\">/* 异常处理，当发生异常的时候设定 not_found的值为1 */</span></span><br><span class=\"line\">    <span class=\"keyword\">Declare</span> continue <span class=\"keyword\">handler</span> <span class=\"keyword\">for</span> <span class=\"keyword\">not</span> <span class=\"keyword\">found</span> <span class=\"keyword\">set</span> not_found=<span class=\"number\">1</span>;</span><br><span class=\"line\">    <span class=\"comment\">/* 设定collectionId的值为 查询出的ID */</span></span><br><span class=\"line\">    <span class=\"keyword\">set</span> collectionId = (<span class=\"keyword\">SELECT</span> <span class=\"keyword\">id</span> <span class=\"keyword\">FROM</span> channelcollection <span class=\"keyword\">where</span> <span class=\"keyword\">name</span>=<span class=\"string\">'b'</span> <span class=\"keyword\">limit</span> <span class=\"number\">1</span>);</span><br><span class=\"line\">    <span class=\"comment\">/* 使用游标之前先打开游标 */</span></span><br><span class=\"line\">    open idCursor;</span><br><span class=\"line\">    <span class=\"comment\">/* 循环游标并且把循环出来的游标赋值给 children_collectionId */</span></span><br><span class=\"line\">    idCursor_loop: LOOP fetch idCursor into children_collectionId;</span><br><span class=\"line\">        if not_found=1 then</span><br><span class=\"line\">            leave idCursor_loop;</span><br><span class=\"line\">        else</span><br><span class=\"line\">            <span class=\"comment\">/* 将数据循环插入另外一个表 */</span></span><br><span class=\"line\">            <span class=\"keyword\">insert</span> <span class=\"keyword\">into</span> channelcollectionfamily <span class=\"keyword\">values</span> (collectionId,children_collectionId);</span><br><span class=\"line\">        <span class=\"keyword\">end</span> <span class=\"keyword\">if</span>;</span><br><span class=\"line\">    <span class=\"keyword\">end</span> <span class=\"keyword\">LOOP</span> idCursor_loop;</span><br><span class=\"line\">    <span class=\"comment\">/* 使用完之后关闭游标 */</span></span><br><span class=\"line\">    close idCursor;</span><br><span class=\"line\"><span class=\"keyword\">END</span></span><br></pre></td></tr></table></figure></div>\n","categories":[{"name":"mysql","slug":"mysql","count":8,"path":"api/categories/mysql.json"},{"name":"游标","slug":"mysql/游标","count":1,"path":"api/categories/mysql/游标.json"}],"tags":[{"name":"mysql","slug":"mysql","count":10,"path":"api/tags/mysql.json"},{"name":"游标","slug":"游标","count":1,"path":"api/tags/游标.json"}]}